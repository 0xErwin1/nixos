#!/usr/bin/env bash
set -euo pipefail

BROWSER="${BROWSER:-"zen-browser"}"
TERMINAL="${TERMINAL:-ghostty}"
DISCORD_CMD="${DISCORD_CMD:-vesktop}"

TMUX_SESSION="${TMUX_SESSION:-main}"

RESURRECT_RESTORE="${RESURRECT_RESTORE:-$HOME/.tmux/plugins/tmux-resurrect/scripts/restore.sh}"

term_exec() {
  local cmd="$*"
  case "$TERMINAL" in
    foot)       echo "$TERMINAL -e bash -lc $(printf %q "$cmd")" ;;
    kitty)      echo "$TERMINAL bash -lc $(printf %q "$cmd")" ;;
    alacritty)  echo "$TERMINAL -e bash -lc $(printf %q "$cmd")" ;;
    wezterm)    echo "$TERMINAL start -- bash -lc $(printf %q "$cmd")" ;;
    ghostty)    echo "$TERMINAL -e bash -lc $(printf %q "$cmd")" ;;
    *)          echo "$TERMINAL -e bash -lc $(printf %q "$cmd")" ;;
  esac
}

already_running() {
  local proc="$1"
  pgrep -xu "$USER" -f -- "$proc" >/dev/null 2>&1
}

tmux_is_running() {
  pgrep -xu "$USER" -x tmux >/dev/null 2>&1
}

btop_is_running() {
  pgrep -xu "$USER" -x btop >/dev/null 2>&1
}

run_hyprland() {
  local w1=1 w2=2 w5=5 w8=8

  if ! already_running "$BROWSER"; then
    hyprctl dispatch exec "[workspace ${w1} silent] ${BROWSER}" >/dev/null
  fi

  if ! tmux_is_running; then
    if [[ -x "$RESURRECT_RESTORE" ]]; then
        tmux_cmd="tmux new-session -A -s ${TMUX_SESSION} \; run-shell ${RESURRECT_RESTORE} \; attach -t ${TMUX_SESSION}"
    else
        tmux_cmd="tmux new-session -A -s ${TMUX_SESSION}"
    fi

    hyprctl dispatch exec "[workspace ${w2} silent] $(term_exec "$tmux_cmd")" >/dev/null

  fi

  if ! btop_is_running; then
    hyprctl dispatch exec "[workspace ${w5} silent] $(term_exec "btop")" >/dev/null
  fi

  if ! already_running "$DISCORD_CMD"; then
    hyprctl dispatch exec "[workspace ${w8} silent] ${DISCORD_CMD}" >/dev/null
  fi
}

main() {
  if [[ "${1:-}" != "--child" ]]; then
    setsid -f "$0" --child >/dev/null 2>&1 || true
    exit 0
  fi

  if command -v hyprctl >/dev/null 2>&1 && [[ -n "${HYPRLAND_INSTANCE_SIGNATURE:-}" ]]; then
    run_hyprland
  else
    echo "Hyprland is not installed or not running."
    exit 1
  fi
}

main "$@"
